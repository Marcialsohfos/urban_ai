name: Sync to Hugging Face

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permet de d√©clencher manuellement

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: Clone Hugging Face repository
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        git clone https://${{ github.actor }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/votre-username/urban-ai hf-repo
    
    - name: Sync files
      run: |
        # Copier tous les fichiers sauf .git
        rsync -av --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.gitignore' \
          ./ hf-repo/
        
        # Cr√©er les dossiers n√©cessaires
        mkdir -p hf-repo/data/uploads/troncons
        mkdir -p hf-repo/data/uploads/taudis
        mkdir -p hf-repo/temp
        touch hf-repo/data/uploads/troncons/.gitkeep
        touch hf-repo/data/uploads/taudis/.gitkeep
        
        # V√©rifier les fichiers essentiels
        if [ ! -f "hf-repo/app.py" ]; then
          echo "‚ùå app.py manquant!"
          exit 1
        fi
        
        if [ ! -f "hf-repo/requirements.txt" ]; then
          echo "‚ùå requirements.txt manquant!"
          exit 1
        fi
    
    - name: Commit and push to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        cd hf-repo
        git add .
        
        # V√©rifier s'il y a des changements
        if git diff --cached --quiet; then
          echo "Aucun changement d√©tect√©"
        else
          git commit -m "üöÄ Sync from GitHub - ${{ github.sha }}"
          git push https://${{ github.actor }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/votre-username/urban-ai main
        fi